# SweepNspect Hub v1.1 — Operations System Guide

## What Changed (v1.0 → v1.1)

### 1. Central Alert System
Every important event in the Hub now triggers an alert that gets persisted, broadcast live to the dashboard, and optionally sent via SMS.

**Alert triggers:**
| Event | Severity | When |
|-------|----------|------|
| Critical/high ticket created | critical/high | Any new ticket via API or webhook |
| Ticket escalated | high | Status changed to `escalated` |
| Subscriber churned | critical | Status changed to `churned` (includes MRR impact) |
| App crash (critical) | critical | Crash webhook with severity=critical |
| Crash auto-escalated | critical | Same crash occurs 5+ times in 24h |
| Clauser went offline | high | Agent misses heartbeat for 45s |
| Webhook ticket (critical/high) | matches priority | External system sends ticket via `/api/webhooks/ticket` |

**API endpoints:**
```
GET  /api/alerts              — List alerts (?limit=50)
POST /api/alerts/:id/acknowledge — Mark alert as seen
GET  /api/alerts/config       — View alert settings
PUT  /api/alerts/config       — Update alert settings
GET  /api/sms/status          — Check Twilio configuration
```

**Storage:** `data/alerts.json` — capped at 200 entries, newest first.

---

### 2. SMS Alerts (Twilio)
Critical and high-severity alerts can be sent via SMS. Disabled by default — enable when ready.

**To configure**, set these environment variables before starting the Hub:
```sh
export TWILIO_SID="your_account_sid"
export TWILIO_TOKEN="your_auth_token"
export TWILIO_FROM="+1234567890"
export ALERT_PHONE="+1987654321"
```

Then enable in config:
```sh
curl -X PUT http://localhost:8888/api/alerts/config \
  -H "Content-Type: application/json" \
  -d '{"sms": {"enabled": true}}'
```

**Batching:** Alerts are batched in a 30-second window so multiple alerts merge into one SMS.
**Cooldown:** Same alert type won't re-send SMS for 5 minutes (prevents spam).
**Graceful:** If Twilio isn't configured, everything else works normally — SMS just no-ops.

---

### 3. Crash Webhook
The mobile app can now report crashes directly to the Hub.

**Endpoint:** `POST /api/webhooks/crash`

**Request body:**
```json
{
  "errorStack": "NullPointerException: ...\nat File.java:42\nat ...",
  "deviceInfo": { "model": "Pixel 7", "os": "Android 14" },
  "appVersion": "2.1.0",
  "severity": "high",
  "userContext": {
    "userName": "Field Inspector",
    "email": "inspector@co.com",
    "subscriberId": "s-001",
    "screen": "InspectionScreen"
  }
}
```

**What happens:**
1. Crash is fingerprinted (MD5 of first 3 stack lines + app version)
2. If a matching open ticket exists within 24h → **merged** (crashCount incremented, device info logged)
3. If no match → **new ticket** created with source `crash-webhook`
4. After **5 occurrences** of the same crash → auto-escalated to critical, alert fired
5. Critical crashes trigger an immediate alert

**Response:**
```json
// New crash:
{ "ok": true, "action": "created", "ticketId": "t-005", "fingerprint": "7d13b8da1f15" }

// Duplicate:
{ "ok": true, "action": "merged", "ticketId": "t-005", "crashCount": 2 }
```

---

### 4. Clauser AI Agent → Proxy
Clauser no longer needs an Anthropic API key. It now routes through the AI Proxy running on the Windows host.

**Before:** `clauser-agent.js` → `api.anthropic.com` (required `ANTHROPIC_API_KEY`)
**After:** `clauser-agent.js` → `http://10.0.2.2:8889/ask` (AI Proxy using `claude --print` CLI)

**Fallback:** If the proxy is unreachable, Clauser generates a basic analysis and notes it's running in fallback mode. Proxy availability is re-checked every 2 minutes.

**To start Clauser:**
```sh
cd ~/sweepnspect-hub
node clauser-agent.js
# or: npm run agent
```

**Environment variables (optional):**
```sh
HUB_URL=http://127.0.0.1:8888    # default
AI_PROXY_URL=http://10.0.2.2:8889 # default (VM → Windows host)
```

---

### 5. Dashboard Alerts UI
The dashboard now shows alerts in three places:

**a) Status Bar Bell**
- Bottom bar, between Clauser status and the clock
- Badge shows unread alert count
- Click to open/close the alert panel

**b) Alert Panel (popup)**
- Slides up from the status bar when bell is clicked
- Shows the 20 most recent alerts with severity dots
- Color-coded: red (critical), yellow (high), cyan (medium), gray (low)

**c) Recent Alerts Panel (dashboard)**
- Below Quick Actions on the Dashboard view
- Shows the 10 most recent alerts
- Updates live via WebSocket

**d) Toast Notifications**
- Severity-colored toast appears at bottom-right for every new alert
- Stacks if multiple alerts arrive at once
- Auto-dismisses after 5 seconds

**e) Desktop Notifications**
- Browser desktop notification for critical/high alerts
- Requires notification permission (prompted on first visit)

---

## Architecture

```
Mobile App
    │
    ├──[crash]──→ POST /api/webhooks/crash ──→ AlertRouter.send()
    │                                              │
External Systems                                   ├──→ data/alerts.json
    │                                              ├──→ WebSocket broadcast
    ├──[ticket]─→ POST /api/webhooks/ticket        ├──→ SMS queue (if enabled)
    │                                              │
Dashboard ←──── WebSocket ←────────────────────────┘
    │
    ├── Alert bell + badge
    ├── Alert panel
    ├── Toast notifications
    └── Desktop notifications

Clauser Agent
    │
    ├──→ GET /api/tickets?status=new  (poll every 30s)
    ├──→ POST http://10.0.2.2:8889/ask  (AI Proxy)
    ├──→ PUT /api/tickets/:id  (write analysis)
    └──→ POST /api/clauser/heartbeat  (every 15s)
```

---

## File Changes Summary

| File | Status | Purpose |
|------|--------|---------|
| `lib/alert-router.js` | NEW | Central alert module |
| `lib/sms.js` | NEW | Twilio SMS wrapper |
| `routes/webhooks.js` | NEW | Crash webhook with fingerprinting |
| `data/alerts.json` | NEW | Alert persistence |
| `server.js` | MODIFIED | Alert infrastructure, endpoints, Clauser offline detection |
| `clauser-agent.js` | MODIFIED | AI Proxy instead of direct API |
| `routes/tickets.js` | MODIFIED | Alert on critical/high create + escalation |
| `routes/subscribers.js` | MODIFIED | Alert on churn |
| `routes/clauser.js` | MODIFIED | Exported isOnline/getStatus |
| `data/config.json` | MODIFIED | Added alerts config block |
| `package.json` | MODIFIED | v1.1.0, twilio dep, agent script |
| `public/index.html` | MODIFIED | Alert bell, badge, panel |
| `public/css/hub.css` | MODIFIED | Alert styles |
| `public/js/lib/notify.js` | MODIFIED | alertToast + alertDesktop |
| `public/js/app.js` | MODIFIED | Alert state, WS handler, panel toggle |
| `public/js/views/dashboard.js` | MODIFIED | Recent Alerts panel |

---

## Quick Reference

```sh
# Start Hub
cd ~/sweepnspect-hub && node server.js

# Start Clauser agent
cd ~/sweepnspect-hub && node clauser-agent.js

# Start AI Proxy (on Windows)
node D:\SweepNspect-Hub\ai-proxy.js

# Test: create critical ticket
curl -X POST http://localhost:8888/api/tickets \
  -H "Content-Type: application/json" \
  -d '{"subject":"Test alert","priority":"critical","customer":{"name":"Test"}}'

# Test: send crash report
curl -X POST http://localhost:8888/api/webhooks/crash \
  -H "Content-Type: application/json" \
  -d '{"errorStack":"Error at line 1","appVersion":"2.0","severity":"high"}'

# Check alerts
curl http://localhost:8888/api/alerts

# Check Clauser status
curl http://localhost:8888/api/clauser/status

# Check AI proxy
curl http://localhost:8888/api/ai/status
```
