# SweepNspect Hub v1.2 — Operations System Guide

## What Changed (v1.1 → v1.2)

### 8. Subscriber Pipeline
Website visitors can now sign up directly, creating tracked subscribers with trial periods.

**Signup Webhook:** `POST /api/webhooks/signup`

```json
{
  "name": "Mike's Chimney Co",
  "email": "mike@example.com",
  "phone": "+15551234567",
  "plan": "pro",
  "source": "website-hero"
}
```

**What happens:**
1. Email is required — all other fields optional
2. Deduplicates by email — if subscriber exists, updates their record
3. Creates subscriber with `status: 'trial'`, `trialEndsAt: +14 days`
4. Fires `subscriber:new` alert + activity feed broadcast
5. Returns `{ ok: true, subscriberId: "s-001", action: "created" | "updated" }`

**Lifecycle:** lead → trial → active → churned (+ founding)

---

### 9. Bug/Feature Tracker (Feedback Webhook)
In-app feedback from users gets auto-categorized and linked to subscribers.

**Feedback Webhook:** `POST /api/webhooks/feedback`

```json
{
  "email": "mike@example.com",
  "subject": "App crashes on inspection save",
  "description": "Every time I tap save...",
  "category": "bug",
  "appVersion": "2.1.0",
  "deviceInfo": { "model": "Pixel 7", "os": "Android 14" }
}
```

**What happens:**
1. Auto-detects category from keywords if not provided:
   - `bug`: broken, crash, error, fail, doesn't work
   - `feature-request`: feature, request, wish, add, suggestion
   - `question`: how, help, where, tutorial
   - `support`: default fallback
2. Auto-links to subscriber by email match
3. Priority bump for active/founding subscribers
4. Creates ticket with category badge

**Ticket categories:** bug | feature-request | question | support
**Dashboard:** Tickets view has filter tabs for each category + color-coded badges (bug=red, feature=purple, question=cyan, support=gray)

---

### 10. Outbound Communications
Send SMS, email, or broadcast to subscriber segments directly from the Hub.

**API endpoints:**
```
POST /api/comms/sms/send       — Send SMS to a phone number
POST /api/comms/email/send     — Send email to an address
POST /api/comms/broadcast      — Blast to subscriber segment
```

**SMS send:**
```json
{ "to": "+15551234567", "body": "Your trial expires tomorrow!" }
```

**Email send:**
```json
{ "to": "mike@example.com", "subject": "Welcome!", "body": "Thanks for signing up..." }
```

**Broadcast:**
```json
{ "channel": "email", "segment": "trial", "subject": "Trial tips", "body": "Here are 3 things..." }
```
Segments: `all` | `active` | `trial` | `churned`

**Dashboard:** Compose button in Comms toolbar — channel picker, subscriber quick-pick, segment selection for broadcasts. All outbound logged to `comms-sms.json` (direction: outbound) / `comms-email-sent.json`.

---

### 11. Marketing Campaigns
Multi-channel campaign builder for coordinated launches.

**API endpoints:**
```
GET    /api/marketing/campaigns/list      — List all campaigns
POST   /api/marketing/campaigns/create    — Create campaign
PUT    /api/marketing/campaigns/:id       — Update campaign
DELETE /api/marketing/campaigns/:id       — Delete campaign
POST   /api/marketing/campaigns/:id/execute — Fire all channels
```

**Create campaign:**
```json
{
  "name": "Launch Week",
  "channels": {
    "facebook": { "enabled": true, "content": "We're live!" },
    "email": { "enabled": true, "subject": "SweepNspect is here", "body": "..." , "segment": "all" },
    "sms": { "enabled": true, "body": "SweepNspect just launched!", "segment": "active" }
  }
}
```

**Execute** fires all enabled channels simultaneously. Results tracked: `emailsSent`, `smsSent`, `fbPostId`, `failures`.

**Storage:** `data/campaigns.json`
**Dashboard:** Campaigns tab in Marketing view with builder modal, status badges, channel indicators.

---

### 12. Global Search
Search across all Hub data from the topbar.

**API endpoint:** `GET /api/search?q=term`

Searches: subscribers, tickets, SMS conversations, sent emails, live chat sessions, marketing posts.

**Response:**
```json
{
  "results": [
    { "type": "subscriber", "id": "s-001", "title": "Mike's Chimney", "subtitle": "mike@example.com", "match": "name", "route": "#customers/s-001" }
  ],
  "total": 1
}
```

**Dashboard:** Search bar in topbar (visible on screens ≥600px), debounced 250ms, grouped dropdown results. Click navigates to the matching item.

---

## What Changed (v1.0 → v1.1)

### 1. Central Alert System
Every important event in the Hub now triggers an alert that gets persisted, broadcast live to the dashboard, and optionally sent via SMS.

**Alert triggers:**
| Event | Severity | When |
|-------|----------|------|
| Critical/high ticket created | critical/high | Any new ticket via API or webhook |
| Ticket escalated | high | Status changed to `escalated` |
| Subscriber churned | critical | Status changed to `churned` (includes MRR impact) |
| App crash (critical) | critical | Crash webhook with severity=critical |
| Crash auto-escalated | critical | Same crash occurs 5+ times in 24h |
| Clauser went offline | high | Agent misses heartbeat for 45s |
| Webhook ticket (critical/high) | matches priority | External system sends ticket via `/api/webhooks/ticket` |

**API endpoints:**
```
GET  /api/alerts              — List alerts (?limit=50)
POST /api/alerts/:id/acknowledge — Mark alert as seen
GET  /api/alerts/config       — View alert settings
PUT  /api/alerts/config       — Update alert settings
GET  /api/sms/status          — Check Twilio configuration
```

**Storage:** `data/alerts.json` — capped at 200 entries, newest first.

---

### 2. SMS Alerts (Twilio)
Critical and high-severity alerts can be sent via SMS. Disabled by default — enable when ready.

**To configure**, set these environment variables before starting the Hub:
```sh
export TWILIO_SID="your_account_sid"
export TWILIO_TOKEN="your_auth_token"
export TWILIO_FROM="+1234567890"
export ALERT_PHONE="+1987654321"
```

Then enable in config:
```sh
curl -X PUT http://localhost:8888/api/alerts/config \
  -H "Content-Type: application/json" \
  -d '{"sms": {"enabled": true}}'
```

**Batching:** Alerts are batched in a 30-second window so multiple alerts merge into one SMS.
**Cooldown:** Same alert type won't re-send SMS for 5 minutes (prevents spam).
**Graceful:** If Twilio isn't configured, everything else works normally — SMS just no-ops.

---

### 3. Crash Webhook
The mobile app can now report crashes directly to the Hub.

**Endpoint:** `POST /api/webhooks/crash`

**Request body:**
```json
{
  "errorStack": "NullPointerException: ...\nat File.java:42\nat ...",
  "deviceInfo": { "model": "Pixel 7", "os": "Android 14" },
  "appVersion": "2.1.0",
  "severity": "high",
  "userContext": {
    "userName": "Field Inspector",
    "email": "inspector@co.com",
    "subscriberId": "s-001",
    "screen": "InspectionScreen"
  }
}
```

**What happens:**
1. Crash is fingerprinted (MD5 of first 3 stack lines + app version)
2. If a matching open ticket exists within 24h → **merged** (crashCount incremented, device info logged)
3. If no match → **new ticket** created with source `crash-webhook`
4. After **5 occurrences** of the same crash → auto-escalated to critical, alert fired
5. Critical crashes trigger an immediate alert

**Response:**
```json
// New crash:
{ "ok": true, "action": "created", "ticketId": "t-005", "fingerprint": "7d13b8da1f15" }

// Duplicate:
{ "ok": true, "action": "merged", "ticketId": "t-005", "crashCount": 2 }
```

---

### 4. Clauser AI Agent → Proxy
Clauser no longer needs an Anthropic API key. It now routes through the AI Proxy running on the Windows host.

**Before:** `clauser-agent.js` → `api.anthropic.com` (required `ANTHROPIC_API_KEY`)
**After:** `clauser-agent.js` → `http://10.0.2.2:8889/ask` (AI Proxy using `claude --print` CLI)

**Fallback:** If the proxy is unreachable, Clauser generates a basic analysis and notes it's running in fallback mode. Proxy availability is re-checked every 2 minutes.

**To start Clauser:**
```sh
cd ~/sweepnspect-hub
node clauser-agent.js
# or: npm run agent
```

**Environment variables (optional):**
```sh
HUB_URL=http://127.0.0.1:8888    # default
AI_PROXY_URL=http://10.0.2.2:8889 # default (VM → Windows host)
```

---

### 5. Dashboard Alerts UI
The dashboard now shows alerts in three places:

**a) Status Bar Bell**
- Bottom bar, between Clauser status and the clock
- Badge shows unread alert count
- Click to open/close the alert panel

**b) Alert Panel (popup)**
- Slides up from the status bar when bell is clicked
- Shows the 20 most recent alerts with severity dots
- Color-coded: red (critical), yellow (high), cyan (medium), gray (low)

**c) Recent Alerts Panel (dashboard)**
- Below Quick Actions on the Dashboard view
- Shows the 10 most recent alerts
- Updates live via WebSocket

**d) Toast Notifications**
- Severity-colored toast appears at bottom-right for every new alert
- Stacks if multiple alerts arrive at once
- Auto-dismisses after 5 seconds

**e) Desktop Notifications**
- Browser desktop notification for critical/high alerts
- Requires notification permission (prompted on first visit)

---

### 6. Marketing & Analytics Tab
New dashboard section for tracking website and app performance.

**Dashboard location:** Sidebar → Marketing

**What it shows:**
- **Top stats:** Website visitors, page views, app downloads, active users, app rating, crash rate
- **Website traffic:** 7-day bar chart + daily table (visitors, page views, bounce rate)
- **Traffic sources:** Visual progress bars (Google Search, Direct, Facebook, Yelp, etc.)
- **App usage:** 7-day bar chart + daily table (downloads, active users, sessions, crashes)
- **Most-used screens:** Ranked list with view counts and avg time
- **Top website pages:** Ranked table with view counts and avg time
- **Ad campaigns:** Table with status, spend, leads, conversions, ROI

**API endpoints:**
```
GET  /api/marketing             — Full marketing data
GET  /api/marketing/website     — Website analytics only
GET  /api/marketing/app         — App analytics only
GET  /api/marketing/campaigns   — Campaigns list
PUT  /api/marketing/campaigns/:index — Update a campaign
```

**Storage:** `data/marketing.json`

---

### 7. Interactive Guide Page
Human-friendly guide accessible from the dashboard sidebar footer ("Open Guide" link).

**URL:** `http://localhost:8888/guide.html`

**Includes:**
- Visual overview of each dashboard section with card-based layout
- "How It Works" feature breakdown
- "What's New in v1.1" summary
- Expandable FAQ section
- AI Assistant chat button
- Fully standalone page (no hub.css dependency, scrolls independently)

---

## Architecture

```
Website (sweepnspect.com)
    │
    ├──[signup form]──→ POST /api/webhooks/signup ──→ creates subscriber (trial)
    ├──[chat widget]──→ CF Worker (KV sessions) ←──→ Hub polls every 8s
    │
Mobile App (SweepNspect)
    │
    ├──[crash]────────→ POST /api/webhooks/crash ──→ AlertRouter.send()
    ├──[feedback]─────→ POST /api/webhooks/feedback → auto-categorized ticket
    │                                                    │
External Systems                                         ├──→ data/alerts.json
    │                                                    ├──→ WebSocket broadcast
    ├──[ticket]───────→ POST /api/webhooks/ticket        ├──→ SMS queue (if enabled)
    │                                                    │
Dashboard ←──────────── WebSocket ←──────────────────────┘
    │
    ├── Alert bell + badge + panel + toasts
    ├── Global search bar (topbar)
    ├── Compose (SMS/email/broadcast)
    ├── Campaign builder (multi-channel)
    ├── Ticket category filters
    └── Desktop notifications

Clauser Agent
    │
    ├──→ GET /api/tickets?status=new  (poll every 30s)
    ├──→ POST http://10.0.2.2:8889/ask  (AI Proxy)
    ├──→ PUT /api/tickets/:id  (write analysis)
    └──→ POST /api/clauser/heartbeat  (every 15s)

Live Chat (CF Worker)
    │
    ├── Session modes: ai → transferring → agent
    ├── AI auto-reply (knowledgebase + learned KB)
    ├── Handoff protocol: defer → phone alert → J joins
    ├── AI note-taking (Haiku extracts from agent replies)
    └── Typing indicators (bidirectional)
```

---

## File Changes Summary

### v1.1 (Alert System, Crash Webhooks, AI Proxy, Marketing Analytics)

| File | Status | Purpose |
|------|--------|---------|
| `lib/alert-router.js` | NEW | Central alert module |
| `lib/sms.js` | NEW | Twilio SMS wrapper + ADB alerts + TTS |
| `routes/webhooks.js` | NEW | Crash + signup + feedback webhooks |
| `data/alerts.json` | NEW | Alert persistence |
| `server.js` | MODIFIED | Alert infrastructure, endpoints, Clauser offline detection |
| `clauser-agent.js` | MODIFIED | AI Proxy instead of direct API |
| `routes/tickets.js` | MODIFIED | Alert on critical/high + category field + filters |
| `routes/subscribers.js` | MODIFIED | Alert on churn + trialEndsAt field |
| `routes/clauser.js` | MODIFIED | Exported isOnline/getStatus |
| `data/config.json` | MODIFIED | Added alerts config block |
| `package.json` | MODIFIED | v1.1.0, twilio dep, agent script |
| `public/index.html` | MODIFIED | Alert bell, badge, panel, search bar |
| `public/css/hub.css` | MODIFIED | Alert styles, category badges, search |
| `public/js/lib/notify.js` | MODIFIED | alertToast + alertDesktop |
| `public/js/app.js` | MODIFIED | Alert state, WS handler, panel toggle, global search |
| `public/js/views/dashboard.js` | MODIFIED | Recent Alerts panel |
| `routes/marketing.js` | NEW | Marketing analytics + campaigns CRUD |
| `data/marketing.json` | NEW | Marketing sample data |
| `public/js/views/marketing.js` | NEW | Marketing dashboard + campaigns tab |
| `public/guide.html` | REWRITTEN | Human-friendly interactive guide |

### v1.2 (Subscriber Pipeline, Outbound Comms, Campaigns, Search, Live Chat)

| File | Status | Purpose |
|------|--------|---------|
| `routes/webhooks.js` | MODIFIED | Added signup + feedback webhooks |
| `routes/tickets.js` | MODIFIED | Category field + category filter |
| `routes/subscribers.js` | MODIFIED | trialEndsAt in allowed fields |
| `routes/comms.js` | MODIFIED | Outbound SMS/email/broadcast endpoints |
| `routes/marketing.js` | MODIFIED | Campaigns CRUD + execute endpoint |
| `routes/search.js` | NEW | Global search across all data stores |
| `routes/livechat.js` | MODIFIED | Handoff, typing, notes, AI reply, handback |
| `server.js` | MODIFIED | Mounted search route, new data stores |
| `public/js/views/tickets.js` | MODIFIED | Category filters + badges |
| `public/js/views/comms.js` | MODIFIED | Compose modal, live chat handoff UI |
| `public/js/views/marketing.js` | MODIFIED | Campaigns tab + builder modal |
| `public/js/app.js` | MODIFIED | Global search methods |
| `public/index.html` | MODIFIED | Search bar in topbar |
| `public/css/hub.css` | MODIFIED | Category badges, search bar styles |
| `public/js/chat-widget.js` | MODIFIED | Handoff UX, typing indicators, mode display |
| `data/campaigns.json` | NEW | Campaign storage |
| `data/comms-email-sent.json` | NEW | Outbound email log |
| `data/kb-learned.json` | NEW | AI-learned knowledgebase entries |
| `data/livechat-sessions.json` | NEW | Live chat session storage |
| `lib/sms.js` | MODIFIED | speakAlert() TTS + openUrl() ADB |
| `lib/worker-poller.js` | MODIFIED | Livechat defer handler with phone alerts |
| `worker/src/index.js` | MODIFIED | Handoff mode, AI notes, typing, DND |

---

## Quick Reference

```sh
# Start Hub (production — pulls vault secrets)
bash D:/Hive/Projects/SweepNspect-Hub/start-hub.sh

# Start Hub (dev)
cd D:/Hive/Projects/SweepNspect-Hub
HUB_API_TOKEN=$(vw-get.sh "SweepNspect Hub Token") node server.js

# Start Clauser agent
cd ~/sweepnspect-hub && node clauser-agent.js

# Start AI Proxy (on Windows)
node D:\SweepNspect-Hub\ai-proxy.js

# Deploy CF Worker
cd D:/Hive/Projects/SweepNspect-Hub/worker && npx wrangler deploy

# Test: website signup
curl -X POST http://localhost:8888/api/webhooks/signup \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Co","email":"test@example.com","plan":"pro"}'

# Test: in-app feedback
curl -X POST http://localhost:8888/api/webhooks/feedback \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","subject":"App crashes","description":"Crash on save"}'

# Test: crash report
curl -X POST http://localhost:8888/api/webhooks/crash \
  -H "Content-Type: application/json" \
  -d '{"errorStack":"Error at line 1","appVersion":"2.0","severity":"high"}'

# Test: send SMS
curl -X POST http://localhost:8888/api/comms/sms/send \
  -H "Content-Type: application/json" \
  -d '{"to":"+15551234567","body":"Hello from Hub"}'

# Test: send email
curl -X POST http://localhost:8888/api/comms/email/send \
  -H "Content-Type: application/json" \
  -d '{"to":"test@example.com","subject":"Test","body":"Hello"}'

# Global search
curl "http://localhost:8888/api/search?q=mike"

# List campaigns
curl http://localhost:8888/api/marketing/campaigns/list

# Check alerts
curl http://localhost:8888/api/alerts

# Check Clauser status
curl http://localhost:8888/api/clauser/status

# Check AI proxy
curl http://localhost:8888/api/ai/status

# Live chat sessions
curl http://localhost:8888/api/livechat/sessions

# Open guide
open http://localhost:8888/guide.html
```
